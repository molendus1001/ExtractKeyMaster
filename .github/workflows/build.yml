name: Build Keymaster Extractor

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r21e

    - name: Build with NDK
      run: |
        echo "Searching for Android.mk..."
        MK_PATH=$(find . -name Android.mk)
        
        if [ -z "$MK_PATH" ]; then
          echo "Error: Android.mk not found!"
          exit 1
        fi
        
        echo "Found Android.mk at: $MK_PATH"
        
        # We define the project path based on where we found the file
        # If it is in ./jni/Android.mk, NDK expects us to be in root.
        # If it is in ./Android.mk, we need to be explicit.
        
        # This command forces NDK to use the file we found, no matter where it is:
        ndk-build NDK_PROJECT_PATH=. APP_BUILD_SCRIPT="$MK_PATH" APP_PLATFORM=android-21 APP_STL=c++_static

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: keymaster-tools
        path: libs/
